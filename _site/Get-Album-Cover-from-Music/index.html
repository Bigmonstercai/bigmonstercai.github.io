<!DOCTYPE html>
<html>
  <head>
    <title>利用Python从音乐文件中提取专辑封面 – Bigmonstercai – Is Learning</title>

        <meta charset="utf-8" />
    <meta content='text/html; charset=utf-8' http-equiv='Content-Type'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1.0'>

    
    <meta name="description" content="本文探讨利用Python从MP3、M4A等音乐文件中提取出专辑封面图片的方法" />
    <meta property="og:description" content="本文探讨利用Python从MP3、M4A等音乐文件中提取出专辑封面图片的方法" />
    
    <meta name="author" content="Bigmonstercai" />

    
    <meta property="og:title" content="利用Python从音乐文件中提取专辑封面" />
    <meta property="twitter:title" content="利用Python从音乐文件中提取专辑封面" />
    

    <!--[if lt IE 9]>
      <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="alternate" type="application/rss+xml" title="Bigmonstercai - Is Learning" href="/feed.xml" />

    <!-- Created with Jekyll Now - http://github.com/barryclark/jekyll-now -->
  </head>

  <body>
    <div class="wrapper-masthead">
      <div class="container">
        <header class="masthead clearfix">
          <a href="/" class="site-avatar"><img src="/images/logo.png" /></a>

          <div class="site-info">
            <h1 class="site-name"><a href="/">Bigmonstercai</a></h1>
            <a class="site-description">Is Learning</a>
          </div>

          <nav>
            <a href="/">Blog</a>
            <a href="/tags">Tags</a>
            <a href="/about">About</a>
          </nav>
        </header>
      </div>
    </div>

    <div id="main" role="main" class="container">
      <article class="post">
  <h1>利用Python从音乐文件中提取专辑封面</h1>

  <div class="entry">
    <p>使用iTunes管理音乐文件时，我给每张专辑都设置了专辑封面。iTunes把专辑封面图片嵌入到了每一个音频文件中，当我们在资源管理器中以缩略图的形式查看这些文件时，就可以看到每个音频文件显示的都是专辑封面。</p>

<p><img src="/images//Get-Album-Cover-from-Music//1.png" alt="1" /></p>

<p>在我突发奇想制作<a href="https://github.com/Bigmonstercai/Music-Album-with-music-albums/">“来自封面们的封面”</a>这个可视化效果时，需要从这些音频文件中提取出专辑封面，本文将具体探讨利用Python提取专辑封面的方法。</p>

<p>#<a name="Audio">音乐格式浅析</a></p>

<p>我的音乐文件主要有MP3文件和M4A文件两种，因此下面我将简要介绍下这两种音频格式，重点为专辑封面是如何嵌入在这两种格式的文件中的。</p>

<p>##<a name="MP3">MP3</a></p>

<p>MP3文件使用ID3记录歌曲信息。ID3有两个版本，ID3v1在MP3文件的末尾128字节，以TAG开头，记录标题、作者、专辑、出品年代、类型、音轨序号等信息；ID3v2在MP3文件的头部，以ID3开头，由许多“帧”构成，每一帧记录一种属性，可以方便的扩展。下表是ID3v2的结构：</p>

<p><img src="/images//Get-Album-Cover-from-Music//2.png" alt="2" /></p>

<p>以下是ID3v2各帧的定义：</p>
<blockquote>

AENC	Audio encryption

APIC	Attached picture

COMM	Comments

COMR	Commercial frame

ENCR	Encryption method registration

EQUA	Equalization

ETCO	Event timing codes

GEOB	General encapsulated object

GRID	Group identification registration

IPLS	Involved people list

LINK	Linked information

MCDI	Music CD identifier

MLLT	MPEG location lookup table

OWNE	Ownership frame

PRIV	Private frame

PCNT	Play counter

POPM	Popularimeter

POSS	Position synchronisation frame

RBUF	Recommended buffer size

RVAD	Relative volume adjustment

RVRB	Reverb

SYLT	Synchronized lyric/text

SYTC	Synchronized tempo codes

TALB	Album/Movie/Show title

TBPM	BPM (beats per minute)

TCOM	Composer

TCON	Content type

TCOP	Copyright message

TDAT	Date

TDLY	Playlist delay

TENC	Encoded by

TEXT	Lyricist/Text writer

TFLT	File type

TIME	Time

TIT1	Content group description

TIT2	Title/songname/content description

TIT3	Subtitle/Description refinement

TKEY	Initial key

TLAN	Language(s)

TLEN	Length

TMED	Media type

TOAL	Original album/movie/show title

TOFN	Original filename

TOLY	Original lyricist(s)/text writer(s)

TOPE	Original artist(s)/performer(s)

TORY	Original release year

TOWN	File owner/licensee

TPE1	Lead performer(s)/Soloist(s)

TPE2	Band/orchestra/accompaniment

TPE3	Conductor/performer refinement

TPE4	Interpreted, remixed, or otherwise modified by

TPOS	Part of a set

TPUB	Publisher

TRCK	Track number/Position in set

TRDA	Recording dates

TRSN	Internet radio station name

TRSO	Internet radio station owner

TSIZ	Size

TSRC	ISRC (international standard recording code)

TSSE	Software/Hardware and settings used for encoding

TYER	Year

TXXX	User defined text information frame

UFID	Unique file identifier

USER	Terms of use

USLT	Unsychronized lyric/text transcription

WCOM	Commercial information

WCOP	Copyright/Legal information

WOAF	Official audio file webpage

WOAR	Official artist/performer webpage

WOAS	Official audio source webpage

WORS	Official internet radio station homepage

WPAY	Payment

WPUB	Publishers official webpage

WXXX	User defined URL link frame
</blockquote>
<p>对于专辑封面，我们需要读取的是APIC。</p>

<p>##<a name="M4A">M4A</a></p>

<p>M4A文件也使用了一种类似于ID3的方式按帧存储音频文件的信息，称作ATOM。关于M4A格式的详细说明文档可以到<a href="http://download.csdn.net/detail/bigmonstercai/9131325">这里</a>下载查看，我就不再赘述了。</p>

<p>在M4A格式的文件中，专辑封面的标志字为covr。</p>

<p>#<a name="Image">图片格式浅析</a></p>

<p>内嵌在音频文件中的图片通常为JPG或PNG格式的，为了将它们提取出来，我们需要对这两种图片的格式也有所了解。</p>

<p>##<a name="JPG">JPG</a></p>

<p>JPG文件采用<a href="https://en.wikipedia.org/wiki/JPEG_File_Interchange_Format">JPEG File Interchange Format(JFIF)</a>标准，由一系列标记或标记块组成。每个标记有两字节，第一个字节固定为<code>FF</code>，第二个字节表示标记的类型，不为<code>00</code>或<code>FF</code>。JPG文件的开始标记和结束标记分别为<code>FF D8</code>和<code>FF D9</code>。整个文件的结构见下表：</p>

<p><img src="/images//Get-Album-Cover-from-Music//3.png" alt="3" /></p>

<p>对于提取专辑封面，我们只需要知道开始标记和结束标记即可，其他标记的说明可点击本节开头的链接参考维基百科。</p>

<p>##<a name="PNG">PNG</a></p>

<p><a href="https://en.wikipedia.org/wiki/Portable_Network_Graphics">PNG(Portable Network Graphics)</a>文件也由若干数据块组成。</p>

<p><img src="/images//Get-Album-Cover-from-Music//4.png" alt="4" /></p>

<p>除文件头外，其他数据块格式如下：</p>

<p><img src="/images//Get-Album-Cover-from-Music//5.png" alt="5" /></p>

<p>其文件头为<code>89 50 4E 47 0D 0A 1A 0A</code>，图像结束数据块在没有人为加入数据的情况下通常为<code>00 00 00 00 49 45 4E 44 AE 42 60 82</code>。</p>

<p>如需了解PNG格式的其他详细信息，可以查看它的<a href="http://www.w3.org/TR/PNG/">官方说明文档</a>。</p>

<p>#<a name="Python">利用Python提取专辑封面</a></p>

<p>了解了上述信息，就可以开始利用Python编写程序提取音频文件中的专辑封面了。</p>

<p>为了对比字节，找到图片，我们需要使用二进制格式读取(rb)音频文件。</p>

<p>我最初的想法是利用正则表达式匹配图片的文件头及文件尾来找到对应的图片，但是在操作中对于较长的字符串利用正则表达式 <code>b'covr.+?(\xFF\xD8.+?\xFF\xD9)'</code>无法匹配成功，而使用表达式<code>b'covr.+?\xFF\xD8.+?'</code>进行匹配，会发现匹配到的结果\xFF\xD8后面仅有一小部分数据，因此我怀疑Python的正则表达式对字符串的长度有限制。</p>

<p>所以最终我使用了bytes类型的find方法来寻找标志信息在字符串中的位置，通过对整个字符串不断的裁剪，最终获取图片信息。</p>

<p>整个函数的编写我认为用户是知道音频文件的类型的，因此音频文件的格式作为一个输入参数。而音频中内嵌的图片格式我们通常是不知道的，需要程序自行判断。虽然实际中大部分为JPG格式的图片，但是我们默认图片为PNG格式的，因为JPG格式的文件头只有两字节，在音频文件的非图片位置出现的可能性非常高，容易发生误判（即如果文件是PNG格式的，也很有可能在APIC或covr后方找到JPG文件的文件头标志），而PNG格式的文件头有八个字节，发生误判的概率微乎其微。</p>

<p>在实际操作中我还发现，MP3文件中即使APIC帧头没有出现，也是可以正常保存专辑图片的，因此我实际匹配的不是APIC而是ID3。因为一旦ID3没有出现，就说明该文件不存在ID3v2信息。</p>

<p>最后，部分由Photoshop生成的JPG图片，在实际的开始标记前添加了一个伪开始标记，用来增加它自己的一些信息，导致图片不能被其他图片浏览器正常打开。因为图片中除了开始部分，不会再出现<code>FF D8</code>，因此需要检查一下，裁剪掉冗余信息。</p>

<p>以下就是提取专辑图片函数的完整代码：</p>
<link rel="stylesheet" href="\_sass\_highlights.scss" />

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">readAPIC</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">artist</span><span class="p">,</span> <span class="n">album</span><span class="p">,</span> <span class="n">filetype</span><span class="p">):</span>
    <span class="n">fp</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">&#39;rb&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">filetype</span> <span class="o">==</span> <span class="s">&#39;.m4a&#39;</span><span class="p">:</span>
        <span class="n">covr</span> <span class="o">=</span> <span class="n">b</span><span class="s">&#39;covr&#39;</span>
    <span class="k">elif</span> <span class="n">filetype</span> <span class="o">==</span> <span class="s">&#39;.mp3&#39;</span><span class="p">:</span>
        <span class="n">covr</span> <span class="o">=</span> <span class="n">b</span><span class="s">&#39;ID3&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">False</span>
    <span class="n">imagetype</span> <span class="o">=</span> <span class="s">&#39;.png&#39;</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">b</span><span class="s">&#39;</span><span class="se">\x89\x50\x4E\x47\x0D\x0A\x1A\x0A</span><span class="s">&#39;</span>  <span class="c"># 默认为png,因为png的文件头长，误匹配到的概率低</span>
    <span class="n">end</span> <span class="o">=</span> <span class="n">b</span><span class="s">&#39;</span><span class="se">\x00\x00\x00\x00\x49\x45\x4E\x44\xAE\x42\x60\x82</span><span class="s">&#39;</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">fp</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="n">covr_num</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">covr</span><span class="p">)</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">covr_num</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">start_num</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">start</span><span class="p">)</span>
    <span class="n">end_num</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">end</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">start_num</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>  <span class="c"># 不为png则为jpg</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">b</span><span class="s">&#39;</span><span class="se">\xFF\xD8</span><span class="s">&#39;</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">b</span><span class="s">&#39;</span><span class="se">\xFF\xD9</span><span class="s">&#39;</span>
        <span class="n">start_num</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">start</span><span class="p">)</span>
        <span class="n">end_num</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">end</span><span class="p">)</span>
        <span class="n">imagetype</span> <span class="o">=</span> <span class="s">&#39;.jpg&#39;</span>

    <span class="k">if</span> <span class="n">imagetype</span> <span class="o">==</span> <span class="s">&#39;.jpg&#39;</span><span class="p">:</span>
        <span class="n">pic</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">start_num</span><span class="p">:</span> <span class="n">end_num</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span>
        <span class="k">while</span> <span class="n">pic</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">start</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">pic</span> <span class="o">=</span> <span class="n">pic</span><span class="p">[</span><span class="n">pic</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">start</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">imagetype</span> <span class="o">==</span> <span class="s">&#39;.png&#39;</span><span class="p">:</span>
        <span class="n">pic</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">start_num</span><span class="p">:</span> <span class="n">end_num</span> <span class="o">+</span> <span class="mi">12</span><span class="p">]</span>
        <span class="k">while</span> <span class="n">pic</span><span class="p">[</span><span class="mi">8</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">start</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">pic</span> <span class="o">=</span> <span class="n">pic</span><span class="p">[</span><span class="n">pic</span><span class="p">[</span><span class="mi">8</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">start</span><span class="p">)</span> <span class="o">+</span> <span class="mi">8</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">fo</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">&#39;images/&#39;</span> <span class="o">+</span> <span class="n">artist</span> <span class="o">+</span> <span class="s">&#39;-&#39;</span> <span class="o">+</span> <span class="n">album</span> <span class="o">+</span> <span class="n">imagetype</span><span class="p">,</span> <span class="s">&#39;wb&#39;</span><span class="p">)</span>
    <span class="n">fo</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">pic</span><span class="p">)</span>

    <span class="n">fp</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">fo</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> <span class="bp">True</span>	</code></pre></figure>


  </div>

  <div class="date">
    Written on September 21, 2015
  </div>

  
</article>

<a href="#" id="top" class="back"></a>
<style type="text/css">
  #top{position:fixed;bottom:20px;right:20px;}
  .back{background:url( /images/back-top.png ) left center no-repeat; width:50px; height:50px; display:inline-block;}
</style>
<script type="text/javascript">
  var a = document.getElementById("top");
  window.onscroll = function(){
    var x = document.documentElement.scrollTop || document.body.scrollTop;;
    if(x > 1000){
      a.style.display = "inline-block";
    }
    if(x <= 1000){
      a.style.display = "none";
    }
  }
  $('#top').click(function(){$('html,body').animate({scrollTop: '0px'}, 800);return false;});
</script>
    </div>

    <div class="wrapper-footer">
      <div class="container">
        <footer class="footer">
          
<a href="mailto:bigmonstercai@qq.com"><i class="svg-icon email"></i></a>
<a href="https://www.facebook.com/bigmonstercai"><i class="svg-icon facebook"></i></a>

<a href="https://github.com/bigmonstercai"><i class="svg-icon github"></i></a>

<a href="https://www.linkedin.com/in/bigmonstercai"><i class="svg-icon linkedin"></i></a>


<a href="https://www.twitter.com/bigmonstercai"><i class="svg-icon twitter"></i></a>



        </footer>
      </div>
    </div>

    

  </body>
</html>
